---
title: "Macleish Project"
author: "Ben Raivel"
date: "4/6/2019"
output:
  html_document:
    code_folding: hide 
---

```{r, message = FALSE}
library(tidyverse)
library(sf)
library(macleish)
library(utils)

mass_gis1 <- function (layer = "contours5k/hp68") 
{
  dir <- tempdir()
  url <- "http://download.massgis.digital.mass.gov/shapefiles/contours5k/hp68.zip"
  lcl_zip <- file.path(dir, basename(url))
  utils::download.file(url, destfile = lcl_zip)
  lcl_shp <- file.path(dir, layer)
  utils::unzip(lcl_zip, exdir = lcl_shp)
  sf::st_read(lcl_shp) %>% sf::st_transform(4326)
}
mass_gis2 <- function (layer = "contours5k/hp337") 
{
  dir <- tempdir()
  url <- "http://download.massgis.digital.mass.gov/shapefiles/contours5k/hp337.zip"
  lcl_zip <- file.path(dir, basename(url))
  utils::download.file(url, destfile = lcl_zip)
  lcl_shp <- file.path(dir, layer)
  utils::unzip(lcl_zip, exdir = lcl_shp)
  sf::st_read(lcl_shp) %>% sf::st_transform(4326)
}

macleish_intersect <- function (x) 
{
  sf::st_intersection(macleish::macleish_layers[["boundary"]], 
    x)
}

elevation1 <- mass_gis1()
elevation2 <- mass_gis2()

macleish_elevation1 <- macleish_intersect(elevation1)
macleish_elevation2 <- macleish_intersect(elevation2)
```

```{r, message = FALSE}
library(leaflet)

trails <- macleish_layers %>%
  pluck("trails")

macleish_elevation <- rbind(macleish_elevation1, macleish_elevation2)
 
trail_contour_intersect <- st_intersection(trails, macleish_elevation)

contour_multi <- st_cast(trail_contour_intersect, "MULTIPOINT")

contour_point <- st_cast(contour_multi, "POINT")

data <- contour_point %>%
  group_by(name) %>%
  summarise(N = n())

pal <- colorNumeric(palette = "Blues", domain = macleish_elevation$ELEV_M)


leaflet() %>%
  addTiles() %>%
  addPolylines(data = trails, color = "red") %>%
  addPolylines(data = macleish_elevation, color = ~pal(ELEV_M)) %>%
  addMarkers(data = contour_point) 




```

```{r message = FALSE}

trails2 <- data %>%
  select(name, N) %>%
  st_set_geometry(NULL) %>%
  right_join(trails) %>%
  mutate(length = st_length(trails)) %>%
  group_by(name) %>%
  summarize(n = max(N), length = sum(length)) %>%
  mutate(rating = sqrt(n*unclass(length))) %>%
  mutate(class = ifelse(rating > 2/3 * max(rating), "Most Difficult", ifelse(rating > 1/3 * max(rating), "Moderate", "Easiest"))) %>%
  arrange(desc(rating)) %>%
  select(name, class)

trails2

trails3 <- left_join(trails, trails2)
  
palette1 <- colorFactor(
  palette = c("red", "green", "blue"),
  domain = trails2$class)

leaflet() %>%
  addTiles() %>%
  addPolylines(data = trails3, color = ~palette1(class))

```




